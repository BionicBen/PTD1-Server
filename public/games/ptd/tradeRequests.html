<!DOCTYPE html>
<html lang="en">
<head>
    <title>Pokémon Center - View Trades</title>
    <meta charset="UTF-8">
    <link rel='stylesheet' type='text/css' href='/_static/css/base.css'>
    <link rel='stylesheet' type='text/css' href='/_static/css/suckerfish.css'>
    <link rel='stylesheet' type='text/css' href="/_static/css/style.css">
    <!--<script type='text/javascript' src='logging.js'></script>-->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"
            integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous">
    </script>
    <script src="/_static/js/base.js"></script>
    <script src="/_static/js/moves.js"></script>
    <script src="/_static/js/utils.js"></script>
    <script>
        $(function () {
            let saveNum = getCookie('save');

            if(saveNum === null || saveNum < 0) {
                saveNum = 0;
            } else if(saveNum > 2) {
                saveNum = 2;
            }

            console.log(saveNum);

            $.ajax({
                url: '/api/getSaves/?exclude=pokes&save=' + saveNum,
                type: "GET",
                success: function (saves) {
                    if(!successCheck(saves)) {
                        return;
                    }

                    let save = saves[0];
                    initProfile(save['avatar'], save['nickname'], save['badges'], save['money'], saveNum);

                    console.log(saves);
                },
                error: function (error) {
                    console.log(error);
                },
            })

            $.ajax({
                url: '/api/getUserTrades/?save=' + saveNum,
                type: "GET",
                success: function (pokes) {
                    if(!successCheck(pokes, POKEMON)) {
                        return;
                    }

                    pokes.forEach(poke => {
                        console.log(poke);

                        var pokeDiv = document.createElement('div');
                        pokeDiv.id = 'trade_' + poke['id'];
                        pokeDiv.classList.add('block', 'pokemon_compact');

                        var img = document.createElement('img');
                        img.className = 'image';

                        if (poke['shiny'] === 1) {
                            img.src = '/_static/images/pokemon/s_' + poke['pNum'] + '.png';
                            pokeDiv.classList.add('shiny');
                        } else if (poke['shiny'] === 2) {
                            img.src = '/_static/images/pokemon/' + poke['pNum'] + '.png';
                            pokeDiv.classList.add('shadow');
                        } else {
                            img.src = "/_static/images/pokemon/" + poke['pNum'] + ".png";
                        }
                        img.alt = '[Avatar]';

                        const nickname = document.createElement('span');
                        nickname.className = 'name';
                        nickname.innerText = poke['nickname'];

                        const level = document.createElement('span');
                        level.className = 'level';
                        level.innerText = 'Lvl ' + poke['lvl'];

                        const moves = document.createElement('div');
                        moves.className = 'moves';

                        const moves_table = document.createElement('table');
                        const moves_tbody = document.createElement('tbody');

                        for (let i = 1; i < 4; i += 2) {
                            const moves_tr = document.createElement('tr');

                            let move = document.createElement('td');
                            move.className = 'left';
                            move.innerText = get_move(poke['m' + i]);

                            moves_tr.append(move);

                            move = document.createElement('td');
                            move.className = 'right';
                            move.innerText = get_move(poke['m' + (i + 1)]);

                            moves_tr.append(move);

                            moves_tbody.append(moves_tr);
                        }

                        moves_table.append(moves_tbody);
                        moves.append(moves_table);

                        const actions = document.createElement('div');
                        actions.className = 'actions';
                        actions.id = 'create_' + poke['id'];

                        // For right now it won't allow requests for pokemon with auto-trading just put them up on trading center
                        // and let people make offers and let user accept or deny
                        let recall = document.createElement('a');
                        //trade.href = '/games/ptd/tradeMeSetup.php?save=' + saveNum + '&pokeId=' + poke['id'];
                        recall.href = 'javascript:recall(' + poke['id'] + ')';
                        recall.text = 'Recall';

                        actions.append(recall);

                        pokeDiv.append(img, nickname, level, moves, actions);

                        document.getElementById('main').append(pokeDiv);
                    })

                    console.log(pokes);
                },
                error: function (error) {
                    console.log(error);
                },
            });
        });

        function recall(id) {
            const result = window.confirm("Trade the pokemon?");

            if(result) {
                $.ajax({
                    url: '/api/removeTrade/',
                    type: 'POST',
                    data: {
                        'save' : getCookie('save'),
                        'id' : id,
                    },
                    success: function (result) {
                        if(result['success'] === true) {
                            document.getElementById('trade_' + id).remove()
                        }

                        console.log(result);
                    },
                    error: function (error) {
                        console.log(error);
                    },
                })
            }
        }
    </script>
</head>
<body>
<div id="header"></div>
<div id="content">
    <div id="nav"></div>
    <table id="content_table">
        <tbody>
        <tr>
            <td id="sidebar"></td>
            <td id="main">
                <div class="block">
                    <div class="title"><p>Create Trade - <a
                            href="https://ptd1.jordanplayz158.xyz/games/ptd/checkPokemon.php?save=0">Go Back</a></p></div>
                    <div class="content">
                        <p>Here is a list of your Pokémon from this profile, click on Trade to create a new Trade.</p>
                        <p>NOTE: This will remove the Pokémon from your profile. To get him back to your profile go back
                            to the "Your Trade Request" section and call your Pokémon back.</p>
                    </div>
                </div>
                <div id="pokemonResult"></div>
            </td>
        </tr>
        </tbody>
    </table>
</div>
</body>
</html>